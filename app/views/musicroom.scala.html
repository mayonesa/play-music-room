@import helper._

@(channel: models.channel.Channel, musicLibrary: Iterable[models.song.Song])(implicit  session: play.api.mvc.Session, req: play.api.mvc.RequestHeader)

@main {
    
    <h1>@channel.name @@ @session.get("roomName")</h1>
    
	@javascriptRouter("jsRoutes")(
	    routes.javascript.MusicRoomController.addSong,
	    routes.javascript.MusicRoomController.voteToSkip,
	    routes.javascript.MusicRoomController.leaveRoom,
	    routes.javascript.MusicRoomController.chat,
	    routes.javascript.MusicRoomController.ssePlaylistAdds,
	    routes.javascript.MusicRoomController.sseChats,
	    routes.javascript.MusicRoomController.sseSongInfos,
	    routes.javascript.MusicRoomController.playSong
	)    
	<!-- TODO: on unload, leave room (handle refresh as well) -->
    <div id="libContainer">
        <ul>
        @musicLibrary.map { song =>
            <li>@song.name - @song.artist (@song.length)<input type="button" value="Add" onclick="addSong(@song.id);"></li>
        }
        </ul>
    </div>
    <div id="playerContainer">
    	<audio autoplay>
    		<p>Your browser does not support this audio player/format. Try from a more current/common one.</p>
    	</audio>
    </div>
    @if(channel.isInstanceOf[models.playlist.PlaylistViewer]) {
    	<div id="playlistContainer">
    		<ul id="playlist">
    		</ul>
    	</div>
    }
    <div id="voteToSkipContainer"><button onclick="voteToSkip();">Vote to Skip to Next Song</button></div>
    @if(channel.isInstanceOf[models.chatbox.client.ChatBoxListener]) {
	    <div id="chatLog"></div>
		@if(channel.isInstanceOf[models.chatbox.client.ChatBoxFullClient]) {
   			<div id="chatContainer">
				<label>talk
					<input type="text" id="text" required="required">
					<input type="button" value="Send" class="buttons" onclick="chat()"/>
				</label>
		 	</div>
 		}
 	}
    <div id="leaveRoomContainer"><button onclick="leaveRoom();">Leave Room</button></div>
    <script>
    var channelId = @channel.id;
    var alreadyVoted = false;
    var currentSongId = null;
    var $chat;
    $(function() {
    	$chat = $("#text");
    });
    function addSong(songId) {
        $.ajax(jsRoutes.controllers.MusicRoomController.addSong(channelId, songId))
    };
    function voteToSkip() {
    	if (!currentSongId) {
    		alert("no song playing");
    	} else if (alreadyVoted) {
    		alert("already voted to skip this song");
    	} else {
    		alreadyVoted = true;
        	$.ajax(jsRoutes.controllers.MusicRoomController.voteToSkip(channelId, currentSongId))
        }
    };
    function chat() {
        $.post(jsRoutes.controllers.MusicRoomController.chat(channelId),
        	{ 
        		"text": $chat.val() 
        	},
        	function() { 
        		$chat.val("")
        	}
        );
    };
    function leaveRoom() {
        location = jsRoutes.controllers.MusicRoomController.leaveRoom(channelId).url
    };
    function onSongPlay() {
		alreadyVoted = false;
    };
    </script>
    <script src="@routes.Assets.at("javascripts/player.js")" type="text/javascript"></script>
    @if(channel.isInstanceOf[models.playlist.PlaylistViewer]) {
    	<script src="@routes.Assets.at("javascripts/playlist.js")" type="text/javascript"></script>
    }
    @if(channel.isInstanceOf[models.chatbox.client.ChatBoxListener]) {
    	<script src="@routes.Assets.at("javascripts/chatLog.js")" type="text/javascript"></script>
	}
}
